<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Timer</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 100vw;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: var(--tg-theme-text-color, #000000);
            margin-bottom: 10px;
        }

        .session-indicator {
            padding: 8px 16px;
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .timer-container {
            background: var(--tg-theme-secondary-bg-color, #f1f1f1);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 350px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .timer-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--tg-theme-button-color, #0088cc);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }

        .timer-container.active::before {
            transform: scaleX(1);
        }

        .timer-display {
            font-size: 48px;
            font-weight: 300;
            color: var(--tg-theme-text-color, #000000);
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
        }

        .progress-ring {
            width: 200px;
            height: 200px;
            margin: 0 auto 20px;
            position: relative;
        }

        .progress-ring svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            fill: none;
            stroke: var(--tg-theme-hint-color, #999999);
            stroke-width: 4;
            opacity: 0.3;
        }

        .progress-ring-progress {
            fill: none;
            stroke: var(--tg-theme-button-color, #0088cc);
            stroke-width: 4;
            stroke-linecap: round;
            stroke-dasharray: 628;
            stroke-dashoffset: 628;
            transition: stroke-dashoffset 1s ease;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            min-width: 80px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 136, 204, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--tg-theme-secondary-bg-color, #f1f1f1);
            color: var(--tg-theme-text-color, #000000);
        }

        .btn-danger {
            background: #ff4757;
            color: white;
        }

        .settings {
            background: var(--tg-theme-secondary-bg-color, #f1f1f1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 350px;
        }

        .settings h3 {
            margin-bottom: 15px;
            color: var(--tg-theme-text-color, #000000);
            font-size: 18px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .setting-item label {
            font-size: 14px;
            color: var(--tg-theme-text-color, #000000);
        }

        .setting-item input {
            width: 60px;
            padding: 5px;
            border: 1px solid var(--tg-theme-hint-color, #999999);
            border-radius: 5px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            text-align: center;
        }

        .stats {
            background: var(--tg-theme-secondary-bg-color, #f1f1f1);
            border-radius: 15px;
            padding: 20px;
            width: 100%;
            max-width: 350px;
            margin-bottom: 20px;
        }

        .stats h3 {
            margin-bottom: 15px;
            color: var(--tg-theme-text-color, #000000);
            font-size: 18px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .stat-value {
            font-weight: 600;
            color: var(--tg-theme-button-color, #0088cc);
        }

        .tomato-animation {
            font-size: 60px;
            animation: bounce 0.6s ease-in-out;
        }

        @keyframes bounce {
            0%, 20%, 60%, 100% { transform: translateY(0); }
            40% { transform: translateY(-20px); }
            80% { transform: translateY(-10px); }
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 500;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .tabs {
            display: flex;
            background: var(--tg-theme-secondary-bg-color, #f1f1f1);
            border-radius: 25px;
            padding: 4px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 350px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .tab.active {
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .tab-content {
            display: none;
            width: 100%;
            max-width: 350px;
        }

        .tab-content.active {
            display: block;
        }

        .hidden {
            display: none !important;
        }

        .task-list {
            background: var(--tg-theme-secondary-bg-color, #f1f1f1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .task-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--tg-theme-hint-color, #999999);
            border-radius: 8px;
            margin-bottom: 10px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }

        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--tg-theme-hint-color, #999999);
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-item.completed {
            opacity: 0.6;
            text-decoration: line-through;
        }

        .task-actions {
            display: flex;
            gap: 10px;
        }

        .task-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .task-btn.complete {
            background: #2ed573;
            color: white;
        }

        .task-btn.delete {
            background: #ff4757;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçÖ Pomodoro Timer</h1>
            <div class="session-indicator" id="sessionIndicator">–°–µ—Å—Å–∏—è —Ä–∞–±–æ—Ç—ã</div>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="timer">–¢–∞–π–º–µ—Ä</div>
            <div class="tab" data-tab="tasks">–ó–∞–¥–∞—á–∏</div>
            <div class="tab" data-tab="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        </div>

        <div class="tab-content active" id="timer-tab">
            <div class="timer-container" id="timerContainer">
                <div class="progress-ring">
                    <svg>
                        <circle class="progress-ring-circle" cx="100" cy="100" r="90"></circle>
                        <circle class="progress-ring-progress" cx="100" cy="100" r="90" id="progressCircle"></circle>
                    </svg>
                    <div class="timer-display" id="timerDisplay">25:00</div>
                </div>
                <div class="tomato-animation" id="tomatoAnimation">üçÖ</div>
            </div>

            <div class="controls">
                <button class="btn" id="startBtn" onclick="startTimer()">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
                <button class="btn btn-secondary" id="pauseBtn" onclick="pauseTimer()">‚è∏Ô∏è –ü–∞—É–∑–∞</button>
                <button class="btn btn-danger" id="resetBtn" onclick="resetTimer()">üîÑ –°–±—Ä–æ—Å</button>
            </div>

            <div class="stats">
                <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
                <div class="stat-item">
                    <span>–ó–∞–≤–µ—Ä—à–µ–Ω–æ –ø–æ–º–æ–¥–æ—Ä–æ:</span>
                    <span class="stat-value" id="completedPomodoros">0</span>
                </div>
                <div class="stat-item">
                    <span>–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:</span>
                    <span class="stat-value" id="workTime">0 –º–∏–Ω</span>
                </div>
                <div class="stat-item">
                    <span>–í—Ä–µ–º—è –æ—Ç–¥—ã—Ö–∞:</span>
                    <span class="stat-value" id="breakTime">0 –º–∏–Ω</span>
                </div>
                <div class="stat-item">
                    <span>–¢–µ–∫—É—â–∞—è —Å–µ—Ä–∏—è:</span>
                    <span class="stat-value" id="currentStreak">0</span>
                </div>
            </div>
        </div>

        <div class="tab-content" id="tasks-tab">
            <div class="task-list">
                <h3>üìù –ó–∞–¥–∞—á–∏</h3>
                <input type="text" class="task-input" id="taskInput" placeholder="–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É...">
                <button class="btn" onclick="addTask()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                <div id="taskList"></div>
            </div>
        </div>

        <div class="tab-content" id="settings-tab">
            <div class="settings">
                <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—Ä–µ–º–µ–Ω–∏</h3>
                <div class="setting-item">
                    <label>–†–∞–±–æ—Ç–∞ (–º–∏–Ω):</label>
                    <input type="number" id="workDuration" value="25" min="1" max="60">
                </div>
                <div class="setting-item">
                    <label>–ö–æ—Ä–æ—Ç–∫–∏–π –ø–µ—Ä–µ—Ä—ã–≤ (–º–∏–Ω):</label>
                    <input type="number" id="shortBreakDuration" value="5" min="1" max="30">
                </div>
                <div class="setting-item">
                    <label>–î–ª–∏–Ω–Ω—ã–π –ø–µ—Ä–µ—Ä—ã–≤ (–º–∏–Ω):</label>
                    <input type="number" id="longBreakDuration" value="15" min="1" max="60">
                </div>
                <div class="setting-item">
                    <label>–ü–æ–º–æ–¥–æ—Ä–æ –¥–æ –¥–ª–∏–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ—Ä—ã–≤–∞:</label>
                    <input type="number" id="longBreakInterval" value="4" min="2" max="10">
                </div>
                <div class="controls">
                    <button class="btn" onclick="saveSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="btn btn-secondary" onclick="syncData()">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
                <div class="controls">
                    <button class="btn btn-secondary" onclick="exportData()">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
                    <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
                </div>
            </div>
            
            <div class="settings">
                <h3>‚òÅÔ∏è –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</h3>
                <div class="setting-item">
                    <label>Telegram CloudStorage:</label>
                    <span id="cloudStorageStatus" class="stat-value"></span>
                </div>
                <div class="setting-item">
                    <label>–†–µ–∑–µ—Ä–≤–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ:</label>
                    <span class="stat-value">localStorage</span>
                </div>
                <div class="setting-item">
                    <label>–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:</label>
                    <span class="stat-value">–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫</span>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–º—ã
        document.body.style.backgroundColor = tg.backgroundColor || '#ffffff';
        document.body.style.color = tg.textColor || '#000000';

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ CloudStorage
        const isCloudStorageAvailable = tg.CloudStorage && typeof tg.CloudStorage.getItems === 'function';
        console.log('CloudStorage –¥–æ—Å—Ç—É–ø–µ–Ω:', isCloudStorageAvailable);

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º
        function setStorageItem(key, value) {
            const stringValue = JSON.stringify(value);
            
            if (isCloudStorageAvailable) {
                tg.CloudStorage.setItem(key, stringValue, (error) => {
                    if (error) {
                        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ CloudStorage:', error);
                        // Fallback –Ω–∞ localStorage
                        localStorage.setItem(key, stringValue);
                    }
                });
            } else {
                // Fallback –Ω–∞ localStorage
                localStorage.setItem(key, stringValue);
            }
        }

        function getStorageItem(key, callback) {
            if (isCloudStorageAvailable) {
                tg.CloudStorage.getItem(key, (error, value) => {
                    if (error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ CloudStorage:', error);
                        // Fallback –Ω–∞ localStorage
                        const fallbackValue = localStorage.getItem(key);
                        callback(fallbackValue ? JSON.parse(fallbackValue) : null);
                    } else {
                        callback(value ? JSON.parse(value) : null);
                    }
                });
            } else {
                // Fallback –Ω–∞ localStorage
                const value = localStorage.getItem(key);
                callback(value ? JSON.parse(value) : null);
            }
        }

        function getStorageItems(keys, callback) {
            if (isCloudStorageAvailable) {
                tg.CloudStorage.getItems(keys, (error, values) => {
                    if (error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ CloudStorage:', error);
                        // Fallback –Ω–∞ localStorage
                        const fallbackValues = {};
                        keys.forEach(key => {
                            const value = localStorage.getItem(key);
                            fallbackValues[key] = value ? JSON.parse(value) : null;
                        });
                        callback(fallbackValues);
                    } else {
                        const parsedValues = {};
                        for (const key in values) {
                            parsedValues[key] = values[key] ? JSON.parse(values[key]) : null;
                        }
                        callback(parsedValues);
                    }
                });
            } else {
                // Fallback –Ω–∞ localStorage
                const values = {};
                keys.forEach(key => {
                    const value = localStorage.getItem(key);
                    values[key] = value ? JSON.parse(value) : null;
                });
                callback(values);
            }
        }

        function removeStorageItem(key) {
            if (isCloudStorageAvailable) {
                tg.CloudStorage.removeItem(key, (error) => {
                    if (error) {
                        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ CloudStorage:', error);
                    }
                });
            } else {
                localStorage.removeItem(key);
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let timer = null;
        let timeLeft = 25 * 60; // 25 –º–∏–Ω—É—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        let isRunning = false;
        let isBreak = false;
        let currentSession = 1;
        let completedSessions = 0;
        let totalWorkTime = 0;
        let totalBreakTime = 0;

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        let settings = {
            workDuration: 25,
            shortBreakDuration: 5,
            longBreakDuration: 15,
            longBreakInterval: 4
        };

        // –ó–∞–¥–∞—á–∏
        let tasks = [];

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        let stats = {
            completedPomodoros: 0,
            workTime: 0,
            breakTime: 0,
            currentStreak: 0
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            showNotification('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö... ‚è≥');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
            loadAllData(() => {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–π–º–µ—Ä–∞ —Å —É—á–µ—Ç–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–∫
                timeLeft = settings.workDuration * 60;
                
                updateDisplay();
                updateProgress();
                updateStats();
                updateSessionIndicator();
                setupTabs();
                
                showNotification('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã! ‚úÖ');
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
            document.getElementById('taskInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addTask();
                }
            });
            
            // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(() => {
                if (isRunning) {
                    saveStats();
                }
            }, 30000);
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            window.addEventListener('beforeunload', () => {
                saveStats();
                saveTasks();
                setStorageItem('pomodoroSettings', settings);
            });
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
        function loadAllData(callback) {
            const keys = ['pomodoroSettings', 'pomodoroTasks', 'pomodoroStats'];
            
            getStorageItems(keys, (values) => {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                if (values.pomodoroSettings) {
                    settings = values.pomodoroSettings;
                }
                document.getElementById('workDuration').value = settings.workDuration;
                document.getElementById('shortBreakDuration').value = settings.shortBreakDuration;
                document.getElementById('longBreakDuration').value = settings.longBreakDuration;
                document.getElementById('longBreakInterval').value = settings.longBreakInterval;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á–∏
                if (values.pomodoroTasks) {
                    tasks = values.pomodoroTasks;
                }
                renderTasks();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                const today = new Date().toDateString();
                if (values.pomodoroStats && values.pomodoroStats.date === today) {
                    stats = values.pomodoroStats;
                } else {
                    // –ù–æ–≤—ã–π –¥–µ–Ω—å - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–Ω–µ–≤–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    stats = {
                        completedPomodoros: 0,
                        workTime: 0,
                        breakTime: 0,
                        currentStreak: 0,
                        date: today
                    };
                    setStorageItem('pomodoroStats', stats);
                }
                
                if (callback) callback();
            });
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–±–∞–º–∏
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    showTab(tabId);
                });
            });
        }

        function showTab(tabId) {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ —Ç–∞–±—ã
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∞–±
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`${tabId}-tab`).classList.add('active');
        }

        // –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–∞–π–º–µ—Ä–∞
        function startTimer() {
            if (!isRunning) {
                isRunning = true;
                document.getElementById('timerContainer').classList.add('active');
                
                timer = setInterval(() => {
                    if (timeLeft > 0) {
                        timeLeft--;
                        updateDisplay();
                        updateProgress();
                    } else {
                        completeSession();
                    }
                }, 1000);
                
                updateButtons();
                showNotification('–¢–∞–π–º–µ—Ä –∑–∞–ø—É—â–µ–Ω! üçÖ');
            }
        }

        function pauseTimer() {
            if (isRunning) {
                isRunning = false;
                clearInterval(timer);
                document.getElementById('timerContainer').classList.remove('active');
                updateButtons();
                showNotification('–¢–∞–π–º–µ—Ä –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ‚è∏Ô∏è');
            }
        }

        function resetTimer() {
            isRunning = false;
            clearInterval(timer);
            document.getElementById('timerContainer').classList.remove('active');
            
            if (isBreak) {
                timeLeft = (currentSession % settings.longBreakInterval === 0) ? 
                    settings.longBreakDuration * 60 : settings.shortBreakDuration * 60;
            } else {
                timeLeft = settings.workDuration * 60;
            }
            
            updateDisplay();
            updateProgress();
            updateButtons();
            showNotification('–¢–∞–π–º–µ—Ä —Å–±—Ä–æ—à–µ–Ω üîÑ');
        }

        function completeSession() {
            isRunning = false;
            clearInterval(timer);
            document.getElementById('timerContainer').classList.remove('active');
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–º–∏–¥–æ—Ä–∞
            const tomato = document.getElementById('tomatoAnimation');
            tomato.style.animation = 'none';
            setTimeout(() => {
                tomato.style.animation = 'bounce 0.6s ease-in-out';
            }, 10);
            
            if (isBreak) {
                // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–µ—Ä–µ—Ä—ã–≤–∞ - –¥–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è –æ—Ç–¥—ã—Ö–∞ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                const completedBreakTime = (completedSessions % settings.longBreakInterval === 0) ? 
                    settings.longBreakDuration : settings.shortBreakDuration;
                stats.breakTime += completedBreakTime;
                
                isBreak = false;
                timeLeft = settings.workDuration * 60;
                updateSessionIndicator();
                showNotification('–ü–µ—Ä–µ—Ä—ã–≤ –∑–∞–∫–æ–Ω—á–µ–Ω! –í—Ä–µ–º—è —Ä–∞–±–æ—Ç–∞—Ç—å! üí™');
                
                // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–≤—É–∫–∞ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('success');
                }
            } else {
                // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—á–µ–π —Å–µ—Å—Å–∏–∏
                completedSessions++;
                stats.completedPomodoros++;
                stats.workTime += settings.workDuration;
                stats.currentStreak++;
                
                // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –ø–µ—Ä–µ—Ä—ã–≤–∞
                if (completedSessions % settings.longBreakInterval === 0) {
                    timeLeft = settings.longBreakDuration * 60;
                    showNotification('–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –í—Ä–µ–º—è –¥–ª—è –¥–ª–∏–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ—Ä—ã–≤–∞! üéâ');
                } else {
                    timeLeft = settings.shortBreakDuration * 60;
                    showNotification('–ü–æ–º–æ–¥–æ—Ä–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –í—Ä–µ–º—è –¥–ª—è –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –ø–µ—Ä–µ—Ä—ã–≤–∞! ‚òï');
                }
                
                isBreak = true;
                updateSessionIndicator();
                
                // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–≤—É–∫–∞ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('success');
                }
            }
            
            updateDisplay();
            updateProgress();
            updateButtons();
            updateStats();
            saveStats();
        }

        function updateDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timerDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateProgress() {
            const totalTime = isBreak ? 
                (completedSessions % settings.longBreakInterval === 0 ? 
                    settings.longBreakDuration * 60 : settings.shortBreakDuration * 60) :
                settings.workDuration * 60;
            
            const progress = (totalTime - timeLeft) / totalTime;
            const circumference = 2 * Math.PI * 90;
            const offset = circumference - (progress * circumference);
            
            document.getElementById('progressCircle').style.strokeDashoffset = offset;
        }

        function updateButtons() {
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (isRunning) {
                startBtn.style.display = 'none';
                pauseBtn.style.display = 'inline-block';
            } else {
                startBtn.style.display = 'inline-block';
                pauseBtn.style.display = 'none';
            }
        }

        function updateSessionIndicator() {
            const indicator = document.getElementById('sessionIndicator');
            if (isBreak) {
                if (completedSessions % settings.longBreakInterval === 0) {
                    indicator.textContent = 'üèñÔ∏è –î–ª–∏–Ω–Ω—ã–π –ø–µ—Ä–µ—Ä—ã–≤';
                } else {
                    indicator.textContent = '‚òï –ö–æ—Ä–æ—Ç–∫–∏–π –ø–µ—Ä–µ—Ä—ã–≤';
                }
            } else {
                indicator.textContent = `üçÖ –°–µ—Å—Å–∏—è —Ä–∞–±–æ—Ç—ã ${completedSessions + 1}`;
            }
        }

        function updateStats() {
            document.getElementById('completedPomodoros').textContent = stats.completedPomodoros;
            document.getElementById('workTime').textContent = stats.workTime + ' –º–∏–Ω';
            document.getElementById('breakTime').textContent = stats.breakTime + ' –º–∏–Ω';
            document.getElementById('currentStreak').textContent = stats.currentStreak;
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
        function saveSettings() {
            settings.workDuration = parseInt(document.getElementById('workDuration').value);
            settings.shortBreakDuration = parseInt(document.getElementById('shortBreakDuration').value);
            settings.longBreakDuration = parseInt(document.getElementById('longBreakDuration').value);
            settings.longBreakInterval = parseInt(document.getElementById('longBreakInterval').value);
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ CloudStorage –∏–ª–∏ localStorage
            setStorageItem('pomodoroSettings', settings);
            showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã! ‚úÖ');
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Ç–∞–π–º–µ—Ä–∞, –µ—Å–ª–∏ –æ–Ω –Ω–µ –∑–∞–ø—É—â–µ–Ω
            if (!isRunning) {
                if (isBreak) {
                    timeLeft = (completedSessions % settings.longBreakInterval === 0) ? 
                        settings.longBreakDuration * 60 : settings.shortBreakDuration * 60;
                } else {
                    timeLeft = settings.workDuration * 60;
                }
                updateDisplay();
                updateProgress();
            }
        }

        function loadSettings(callback) {
            getStorageItem('pomodoroSettings', (savedSettings) => {
                if (savedSettings) {
                    settings = savedSettings;
                }
                
                document.getElementById('workDuration').value = settings.workDuration;
                document.getElementById('shortBreakDuration').value = settings.shortBreakDuration;
                document.getElementById('longBreakDuration').value = settings.longBreakDuration;
                document.getElementById('longBreakInterval').value = settings.longBreakInterval;
                
                if (callback) callback();
            });
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏
        function addTask() {
            const input = document.getElementById('taskInput');
            const taskText = input.value.trim();
            
            if (taskText) {
                const task = {
                    id: Date.now(),
                    text: taskText,
                    completed: false,
                    createdAt: new Date()
                };
                
                tasks.push(task);
                input.value = '';
                renderTasks();
                saveTasks();
                showNotification('–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞! üìù');
            }
        }

        function toggleTask(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                renderTasks();
                saveTasks();
                showNotification(task.completed ? '–ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞! ‚úÖ' : '–ó–∞–¥–∞—á–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞ –≤ —Ä–∞–±–æ—Ç—É üîÑ');
            }
        }

        function deleteTask(id) {
            tasks = tasks.filter(t => t.id !== id);
            renderTasks();
            saveTasks();
            showNotification('–ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞! üóëÔ∏è');
        }

        function renderTasks() {
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '';
            
            tasks.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = `task-item ${task.completed ? 'completed' : ''}`;
                taskItem.innerHTML = `
                    <span>${task.text}</span>
                    <div class="task-actions">
                        <button class="task-btn complete" onclick="toggleTask(${task.id})">
                            ${task.completed ? '‚Ü©Ô∏è' : '‚úÖ'}
                        </button>
                        <button class="task-btn delete" onclick="deleteTask(${task.id})">üóëÔ∏è</button>
                    </div>
                `;
                taskList.appendChild(taskItem);
            });
        }

        function saveTasks() {
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ CloudStorage –∏–ª–∏ localStorage
            setStorageItem('pomodoroTasks', tasks);
        }

        function loadTasks(callback) {
            getStorageItem('pomodoroTasks', (savedTasks) => {
                if (savedTasks) {
                    tasks = savedTasks;
                }
                renderTasks();
                if (callback) callback();
            });
        }

        function saveStats() {
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞—Ç—É –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            const today = new Date().toDateString();
            const statsWithDate = {
                ...stats,
                date: today
            };
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ CloudStorage –∏–ª–∏ localStorage
            setStorageItem('pomodoroStats', statsWithDate);
            
            // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            getStorageItem('pomodoroTotalStats', (totalStats) => {
                if (!totalStats) {
                    totalStats = {
                        totalPomodoros: 0,
                        totalWorkTime: 0,
                        totalBreakTime: 0,
                        bestStreak: 0,
                        totalDays: 0
                    };
                }
                
                totalStats.totalPomodoros += (stats.completedPomodoros || 0);
                totalStats.totalWorkTime += (stats.workTime || 0);
                totalStats.totalBreakTime += (stats.breakTime || 0);
                totalStats.bestStreak = Math.max(totalStats.bestStreak, stats.currentStreak || 0);
                
                setStorageItem('pomodoroTotalStats', totalStats);
            });
        }

        function loadStats(callback) {
            getStorageItem('pomodoroStats', (savedStats) => {
                const today = new Date().toDateString();
                
                if (savedStats && savedStats.date === today) {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è
                    stats = savedStats;
                } else {
                    // –ù–æ–≤—ã–π –¥–µ–Ω—å - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–Ω–µ–≤–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    stats = {
                        completedPomodoros: 0,
                        workTime: 0,
                        breakTime: 0,
                        currentStreak: 0,
                        date: today
                    };
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–±—Ä–æ—à–µ–Ω–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    setStorageItem('pomodoroStats', stats);
                }
                
                if (callback) callback();
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π Telegram Web App
        tg.onEvent('mainButtonClicked', function() {
            if (isRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        });

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–ª–∞–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
        tg.MainButton.text = '–°—Ç–∞—Ä—Ç';
        tg.MainButton.show();

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
        function updateMainButton() {
            if (isRunning) {
                tg.MainButton.text = '–ü–∞—É–∑–∞';
            } else {
                tg.MainButton.text = '–°—Ç–∞—Ä—Ç';
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ CloudStorage
        function updateCloudStorageStatus() {
            const statusElement = document.getElementById('cloudStorageStatus');
            if (statusElement) {
                statusElement.textContent = isCloudStorageAvailable ? '‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ' : '‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        setInterval(() => {
            updateMainButton();
            updateCloudStorageStatus();
        }, 100);
    </script>
</body>
</html>
